# README

- [README](#readme)
  - [编译说明](#编译说明)
    - [额外拓展](#额外拓展)
  - [实验流程](#实验流程)
    - [重要规范](#重要规范)
    - [创建硬盘镜像文件](#创建硬盘镜像文件)
    - [copy](#copy)
    - [read](#read)
    - [delete](#delete)
    - [format](#format)
    - [mv](#mv)
    - [rewrite](#rewrite)
    - [cipher \& decrypt](#cipher--decrypt)
      - [加密](#加密)
      - [解密](#解密)
    - [HuffmanZip \& HuffmanUnzip](#huffmanzip--huffmanunzip)
      - [哈夫曼压缩](#哈夫曼压缩)
      - [哈夫曼解压](#哈夫曼解压)
    - [mkdir](#mkdir)
  - [hexdump命令使用](#hexdump命令使用)

## 编译说明

### 额外拓展

1. `Jemalloc`

    ```shell
    # 内存分配优化
    # Ubuntu / Debian
    apt install libjemalloc-dev
    ```

2. `Google Test`

    ```shell
    # 单元测试
    # Ubuntu / Debian
    apt install libgtest-dev
    ```

3. `Doxygen`

    ```shell
    # 生成文档
    # Ubuntu / Debian
    apt install doxygen graphviz
    ```

4. `Flex`

    ```shell
    # 生成正则表达式程序
    # Ubuntu / Debian
    apt install flex
    ```

## 实验流程

### 重要规范

1. 应在所有文件操作准备完全后，才能将数据写入文件系统
2. 文件类型指定必须在合法的文件类型范围内，不合法的文件类型将不被允许写入

### 创建硬盘镜像文件

```shell
# 创建具有4096个数据块，每个数据块512B大小的空硬盘镜像文件
dd if=/dev/zero of=xtfs.img bs=512 count=4096
# 使用 hexdump 命令查看镜像内容
hexdump -C xtfs.img
```

### copy

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在冲突文件，若存在，程序结束，否则继续执行。
3. 读取 inode 表和数据块视图
4. 申请空间：inode 表，数据块，数据块索引表
5. 将文件中内容和对应的数据块索引表拷贝至文件系统中
6. 更新 inode 表
7. 将 inode 表和数据块视图回写至文件系统磁盘或分区

### read

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在对应文件，若存在，继续执行，否则程序结束。
3. 读取 inode 表
4. 根据 inode 表和文件的名称、类型等读取对应文件的 inode 表项
5. 根据 inode 表项读取文件的第一个数据块索引表
6. 根据数据块索引表依次读取文件的数据，并进行输出显示

### delete

删除文件，文件删除需要区分目录文件和其他文件：

- 对于其他文件: 删除其所在的目录的数据块索引表中对应的项（类型改为 NO_FILE），删除在 inode 表中的对应表项（类型改为 NO_FILE）。
- 对于目录文件：注销掉其数据块索引表、inode 表项、父目录数据块索引表中对应栏目。通过修改数据块位图（block_map）和对应的数据结构中的类型（type）为 NO_FILE

    > 2022/12/5: 目前只支持文件的删除，目录的递归删除还没有做到。

操作如下：

1. 使用正则表达式提取出目录和文件名
2. 检查文件是否存在
3. 若文件存在，在数据块位图中置空其所占据全部数据块，删除 inode 表中对应表项（类型改为 NO_FILE），同时删除其所在目录数据块索引表中对应的表项（类型改为 NO_FILE）；若不存在，报错退出。

### format

格式化

1. 覆盖 inode 表和数据块位图
2. 将根目录和其占用的数据块索引表写入
3. 设置初始的数据块位图（0、1号数据块和根目录占据的数据块）
4. 写入 XTFS 文件系统分区

### mv

剪切，将源文件/目录剪切至目标目录，保留名称。

1. 使用正则表达式识别出源文件/目录名和目标目录名（目标必须是目录）
2. 判断源文件/目录名是否存在
3. 判断目标目录是否存在
4. 判断目标目录下是否存在与源文件/目录相同的文件
5. 若存在，报错退出；若不存在，删除源文件/目录在其原目录数据块索引表中的表项（类型修改为 NO_FILE），在目标目录中添加对应的表项（文件/目录 inode 表项位置，名称等），剪切完毕

### rewrite

覆写，给定源文件和新文件，将新文件内容重写至源文件，不更改源文件名

1. 使用正则表达式识别出源文件和目标文件名
2. 判断源文件是否存在，若不存在，报错退出；若存在，记录
3. 判断新文件是否存在，若不存在，报错退出；若存在，记录
4. 将新文件内容写至源文件，同时正确变更数据块位图等信息
5. 写入 XTFS 文件系统分区

### cipher & decrypt

#### 加密

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在冲突文件，若存在，程序结束，否则继续执行。
3. 读取 inode 表和数据块视图
4. 申请空间：inode 表，数据块，数据块索引表
5. 将文件中内容和对应的数据块索引表拷贝至文件系统中，同时进行加密
6. 更新 inode 表
7. 将 inode 表和数据块视图回写至文件系统磁盘或分区

#### 解密

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在对应文件，若存在，继续执行，否则程序结束。
3. 读取 inode 表
4. 根据 inode 表和文件的名称、类型等读取对应文件的 inode 表项
5. 根据 inode 表项读取文件的第一个数据块索引表
6. 根据数据块索引表依次读取文件的数据，并进行输出显示，在这其中进行解密

### HuffmanZip & HuffmanUnzip

#### 哈夫曼压缩

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在冲突文件，若存在，程序结束，否则继续执行。
3. 读取 inode 表和数据块视图
4. 申请空间：inode 表，数据块，数据块索引表
5. 将文件中内容和对应的数据块索引表拷贝至文件系统中，同时进行压缩
6. 更新 inode 表
7. 将 inode 表和数据块视图回写至文件系统磁盘或分区

#### 哈夫曼解压

1. 使用正则表达式提取出目录和文件名
2. 根据目录查找是否存在对应文件，若存在，继续执行，否则程序结束。
3. 读取 inode 表
4. 根据 inode 表和文件的名称、类型等读取对应文件的 inode 表项
5. 根据 inode 表项读取文件的第一个数据块索引表
6. 根据数据块索引表依次读取文件的数据，并进行输出显示，在这其中进行解压

### mkdir

创建目录

1. 获取需要创建的完整目录路径，名称格式由正则表达式保证
2. 由正则表达式提取从左至右提取目录元素。若没有元素或匹配失败，程序退出并输出相应错误。
3. 从左至右，从根目录为父目录开始，对每一个目录元素作 `5-7` 操作，直至结束。
4. 查看父目录下对应的数据块索引表中有无当前的目录元素
5. 若有，直接进入该目录元素，获取其 inode 表项，将其作为父目录，迭代至下一目录元素，没有下一个则结束
6. 若没有，先在父目录的数据块索引表中创建，然后将其作为父目录，迭代至下一目录元素，没有下一个则结束。

这里使用 [Flex(https://github.com/westes/flex)](https://github.com/westes/flex) 构建识别目录的正则表达式的程序。

加入目录后，inode 表和目录的 index table 中查找文件的方法需要进行大变化：

    - inode 表中允许出现相同文件名、相同类型的表项，这些由读写过程保证不会发生冲突。同时只允许一个文件名为 `/` 即根目录，这个由正则表达式保证
    - 一个目录的 index table 中不允许出现文件名和类型都一样的表项，但允许出现文件名相同但类型是文件和目录的两个文件，这个由读写过程保证不会发生。同时 index table 也不允许出现文件名为 `/` 即根目录的结构，这个由正则表达式保证

关于文件类型检查，去除特殊格式，可以分成基本格式类型和目录文件类型。目录的 index table 检查两个同名文件是否是同一类型，若是同一类型，判定为已存在；不是，判定为两个不同文件。

1. 任何读、写文件操作的输入应该是文件名+完整的目录路径，然后使用正则表达式进行提取和其中的检验保证。接着在数据块索引表中找到下一目录在 inode 表中的位置。
2. 不允许直接删除目录文件，只有在目录的数据块索引表中没有存储任何文件（文件类型为 NO_FILE ）时，才允许删除目录文件。

  > 2022/11/20: 目录现只支持创建，不支持删除，剪切，拷贝等操作
  > 2022/12/5: 目录现支持剪切

## hexdump命令使用

参数：

1. `-b` 一个字节以三位8进制数输出
2. `-c` 一个字节以其代表的ASCII码显示
3. `-C` 十六进制+ASCII码显示
4. `-d` 两字节合并以十进制显示
5. `-o` 两字节合并以八进制显示
6. `-x` 两字节合并以16进制显示
7. `-e` 格式化输出
8. `-n` 指定输出多少bytes的字符长度内容
9. `-s` 指定文件读取偏移量（从0计算）
